name: Build Lockpick_RCM Chinese - 20251204

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: devkitpro/devkita64:latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4.1.1
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Fix git dubious ownership
      run: |
        git config --global --add safe.directory ${{ github.workspace }}
      shell: bash

    - name: Setup environment
      run: |
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "DEVKITARM=/opt/devkitpro/devkitARM" >> $GITHUB_ENV
        echo "/opt/devkitpro/devkitARM/bin" >> $GITHUB_PATH
      shell: bash

    - name: Extract version from Versions.inc
      run: |
        LP_MAJOR=$(awk '/^LPVERSION_MAJOR :=/ {print $3}' Versions.inc)
        LP_MINOR=$(awk '/^LPVERSION_MINOR :=/ {print $3}' Versions.inc)
        LP_BUGFX=$(awk '/^LPVERSION_BUGFX :=/ {print $3}' Versions.inc)
        APP_VERSION="${LP_MAJOR}.${LP_MINOR}.${LP_BUGFX}"
        echo "APP_VERSION=${APP_VERSION}" >> $GITHUB_ENV
        echo "TAG=v${APP_VERSION}" >> $GITHUB_ENV
      shell: bash

    - name: Build project
      run: |
        make clean
        make all -j$(nproc)
      shell: bash

    - name: Check build results
      run: |
        echo "Build completed successfully!"
        ls -la output/
        wc -c output/*.bin

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Lockpick_RCM v${{ env.APP_VERSION }}
        path: |
          output/Lockpick_RCM.bin
          output/Lockpick_RCM_unc.bin
        retention-days: 30

    - name: Create/Update Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          output/Lockpick_RCM.bin
          output/Lockpick_RCM_unc.bin
        name: Lockpick_RCM v${{ env.APP_VERSION }}
        tag_name: ${{ env.TAG }}
        draft: false
        prerelease: false
        generate_release_notes: true
        make_latest: true
        body: |
          ## Lockpick_RCM v${{ env.APP_VERSION }}
          
          ### ğŸ“ æ–‡ä»¶è¯´æ˜
          - `Lockpick_RCM.bin` - å‹ç¼©åçš„payloadï¼ˆç”¨äºæ³¨å…¥ï¼‰
          - `Lockpick_RCM_unc.bin` - æœªå‹ç¼©çš„payload
          
          ### ğŸ”§ æ„å»ºä¿¡æ¯
          - ç‰ˆæœ¬å·ï¼šv${{ env.APP_VERSION }}ï¼ˆæ¥è‡ª Versions.incï¼‰
          - æ„å»ºè§¦å‘ï¼š${{ github.event_name }}
          
          ---
          ä½¿ç”¨ GitHub Actions æ„å»º â¤ï¸
